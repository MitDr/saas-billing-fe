<form (ngSubmit)="onSubmit()" [formGroup]="formGroup()" nz-form>
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="amount" nzRequired>Amount</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Amount is required">
      <input formControlName="amount" id="amount" nz-input placeholder="Description" type="number"/>
    </nz-form-control>
  </nz-form-item>
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="currency" nzRequired>Currency</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Currency is required">
      <nz-select formControlName="currency" nzPlaceHolder="currency">
        @for (opt of currencyOption; track opt.value) {
          <nz-option [nzLabel]="opt.label" [nzValue]="opt.value"></nz-option>
        }
      </nz-select>
    </nz-form-control>
  </nz-form-item>
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="status" nzRequired>Status</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Status is required">
      <nz-select formControlName="status" nzPlaceHolder="status">
        @for (opt of statusOption; track opt.value) {
          <nz-option [nzLabel]="opt.label" [nzValue]="opt.value"></nz-option>
        }
      </nz-select>
    </nz-form-control>
  </nz-form-item>
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="paidDate" nzRequired>Paid Date</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24">
      <nz-date-picker
        [nzFormat]="'dd-MM-yyyy HH:mm:ss'"
        class="w-full" formControlName="paidDate"
        id="paidDate"
        nzAllowClear
        nzPlaceHolder="Choose Paid Date"
        nzShowTime
      ></nz-date-picker>
    </nz-form-control>
  </nz-form-item>
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="billingPeriodStart" nzRequired>Period Start</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24">
      <nz-date-picker
        [nzFormat]="'dd-MM-yyyy HH:mm:ss'"
        class="w-full" formControlName="billingPeriodStart"
        id="startDate"
        nzAllowClear
        nzPlaceHolder="Choose Period Start"
        nzShowTime
      ></nz-date-picker>
    </nz-form-control>
  </nz-form-item>
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="endDate" nzRequired>Period End</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24">
      <nz-date-picker
        [nzFormat]="'dd-MM-yyyy HH:mm:ss'"
        class="w-full" formControlName="billingPeriodEnd"
        id="billingPeriodEnd"
        nzAllowClear
        nzPlaceHolder="Choose Period End"
        nzShowTime
      ></nz-date-picker>
    </nz-form-control>
  </nz-form-item>
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="amountUsd" nzRequired>Amount USD</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Amount USD is required">
      <input formControlName="amountUsd" id="amountUsd" nz-input placeholder="Amount USD" type="number"/>
    </nz-form-control>
  </nz-form-item>
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="exchangeRate" nzRequired>Exchange Rate</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Amount USD is required">
      <input formControlName="exchangeRate" id="exchangeRate" nz-input placeholder="exchangeRate" type="number"/>
    </nz-form-control>
  </nz-form-item>
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Tenant</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24">
      <button (click)="openTenantModal()" nz-button nzType="default" type="button">
        <span nz-icon nzType="container"></span> Choose Tenant
      </button>

      @if (selectedTenant(); as tenant) {
        <nz-card class="mt-3" nzHoverable>
          <nz-card-meta
            nzTitle="{{ tenant.name }}"
            nzDescription="{{ tenant.id }} • {{ tenant.email }}"
          ></nz-card-meta>
          <button type="button" nz-button nzType="link" nzDanger (click)="clearTenant()">Delete</button>
        </nz-card>
      } @else {
        <p class="text-gray-500 mt-2">Tenant is not chosen</p>
      }
    </nz-form-control>
  </nz-form-item>
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Subscription</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24">
      <button (click)="openSubscriptionModal()" nz-button nzType="default" type="button">
        <span nz-icon nzType="wallet"></span> Choose Subscription
      </button>
      @if (selectedSubscription(); as sub) {
        <nz-card class="mt-3" nzHoverable>
          <nz-card-meta
            nzTitle="{{ sub.id }}"
            [nzDescription]="getSubscriptionDescription(sub)"
          ></nz-card-meta>
          <button type="button" nz-button nzType="link" nzDanger (click)="clearSubscription()">Delete</button>
        </nz-card>
      } @else {
        <p class="text-gray-500 mt-2">Subscription is not chosen</p>
      }
    </nz-form-control>
  </nz-form-item>
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Subscriber</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24">
      <button (click)="openSubscriberModal()" nz-button nzType="default" type="button">
        <span nz-icon nzType="wallet"></span> Choose Subscriber
      </button>
      @if (selectedSubscriber(); as sub) {
        <nz-card class="mt-3" nzHoverable>
          <nz-card-meta
            nzTitle="{{ sub.id }}"
            [nzDescription]="getSubscriberDescription(sub)"
          ></nz-card-meta>
          <button type="button" nz-button nzType="link" nzDanger (click)="clearSubscriber()">Delete</button>
        </nz-card>
      } @else {
        <p class="text-gray-500 mt-2">Subscriber is not chosen</p>
      }
    </nz-form-control>
  </nz-form-item>
  <div formArrayName="metadata">
    <div *ngFor="let item of metadataList.controls; let i = index" [formGroupName]="i">

      <nz-form-item>
        <nz-form-label [nzSm]="6">Key</nz-form-label>
        <nz-form-control [nzSm]="7">
          <input formControlName="key" nz-input placeholder="Key"/>
        </nz-form-control>

        <nz-form-label [nzSm]="3">Value</nz-form-label>
        <nz-form-control [nzSm]="6">
          <input formControlName="value" nz-input placeholder="Value"/>
        </nz-form-control>

        <button (click)="removeMetadata(i)" nz-button nzType="default" type="button">
          X
        </button>
      </nz-form-item>

    </div>
  </div>
  <button (click)="addMetadata()" nz-button nzType="dashed" type="button">
    + Add Metadata
  </button>
  <nz-form-item class="mt-8" nz-row>
    <nz-form-control [nzOffset]="6" [nzSpan]="14">
      <button
        [disabled]="formGroup()?.invalid || isLoading()"
        [nzLoading]="isLoading()"
        nz-button
        nzType="primary"
      >
        {{ submitLabel() }}
      </button>
    </nz-form-control>
  </nz-form-item>
</form>
<nz-modal
  (nzOnCancel)="isTenantModalOpen.set(false)"
  (nzOnOk)="isTenantModalOpen.set(false)"
  [nzVisible]="isTenantModalOpen()"
  nzCancelText="Đóng"
  nzOkText="Xác nhận"
  nzTitle="Chọn Tenant"
>
  <ng-template nzModalContent>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
      @if (availableTenants().length === 0) {
        <p class="text-center text-gray-500 py-10">Không có tenant nào để chọn</p>
      } @else {
        @for (tenant of availableTenants(); track tenant.id) {
          <nz-card nzHoverable (click)="selectTenant(tenant)">
            <nz-card-meta
              nzTitle="{{ tenant.name }}"
              nzDescription="{{ tenant.id }} • {{ tenant.email}}"
            ></nz-card-meta>
          </nz-card>
        }
      }
    </div>
  </ng-template>
</nz-modal>
<nz-modal
  (nzOnCancel)="isSubscriptionModalOpen.set(false)"
  (nzOnOk)="isSubscriptionModalOpen.set(false)"
  [nzVisible]="isSubscriptionModalOpen()"
  nzCancelText="Đóng"
  nzOkText="Xác nhận"
  nzTitle="Chọn Subscription"
>
  <ng-template nzModalContent>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
      @if (availableSubscription().length === 0) {
        <p class="text-center text-gray-500 py-10">Không có subscription nào để chọn</p>
      } @else {
        @for (sub of availableSubscription(); track sub.id) {
          <nz-card nzHoverable (click)="selectSubscription(sub)">
            <nz-card-meta
              nzTitle="{{ sub.id }}"
              [nzDescription]="getSubscriptionDescription(sub)"
            ></nz-card-meta>
          </nz-card>
        }
      }
    </div>
  </ng-template>
</nz-modal>
<nz-modal
  (nzOnCancel)="isSubscriberModalOpen.set(false)"
  (nzOnOk)="isSubscriberModalOpen.set(false)"
  [nzVisible]="isSubscriberModalOpen()"
  nzCancelText="Đóng"
  nzOkText="Xác nhận"
  nzTitle="Chọn Subscriber"
>
  <ng-template nzModalContent>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
      @if (availableSubscription().length === 0) {
        <p class="text-center text-gray-500 py-10">Không có Subscriber nào để chọn</p>
      } @else {
        @for (sub of availableSubscriber(); track sub.id) {
          <nz-card nzHoverable (click)="selectSubscriber(sub)">
            <nz-card-meta
              nzTitle="{{ sub.id }}"
              [nzDescription]="getSubscriberDescription(sub)"
            ></nz-card-meta>
          </nz-card>
        }
      }
    </div>
  </ng-template>
</nz-modal>
