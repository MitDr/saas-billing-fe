<form (ngSubmit)="onSubmit()" [formGroup]="formGroup()" nz-form>
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="name" nzRequired>Name</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Name is required">
      <input formControlName="name" id="name" nz-input placeholder="Name.."/>
    </nz-form-control>
  </nz-form-item>
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="image">Name</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Name is required">
      <input formControlName="image" id="image" nz-input placeholder="Image.."/>
    </nz-form-control>
  </nz-form-item>
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="status" nzRequired>Status</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Status is required">
      <nz-select formControlName="status" nzPlaceHolder="status">
        @for (opt of statusOption; track opt.value) {
          <nz-option [nzLabel]="opt.label" [nzValue]="opt.value"></nz-option>
        }
      </nz-select>
    </nz-form-control>
  </nz-form-item>
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24">Plan Group</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24">
      <button (click)="openPlanGroupModal()" nz-button nzType="default" type="button">
        <span nz-icon nzType="container"></span> Choose Plan Group
      </button>

      @if (selectedPlanGroup(); as pg) {
        <nz-card class="mt-3" nzHoverable>
          <nz-card-meta
            nzTitle="{{ pg.name }}"
            nzDescription="{{ pg.id }} • {{ pg.description }}"
          ></nz-card-meta>
          <button type="button" nz-button nzType="link" nzDanger (click)="clearPlanGroup()">Delete</button>
        </nz-card>
      } @else {
        <p class="text-gray-500 mt-2">Plan Group is not chosen</p>
      }
    </nz-form-control>
  </nz-form-item>

  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24">Features</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24">
      <button (click)="openFeatureModal()" nz-button nzType="default" type="button">
        <span nz-icon nzType="team"></span> Chọn Features
      </button>

      <div class="mt-3 flex flex-wrap gap-2">
        @for (fe of selectedFeatures(); track fe.id) {
          <nz-tag
            nzColor="geekblue"
            nzClosable
            (nzOnClose)="removeSelectedFeature(fe.id)"
          >
            {{ getFeatureDescription(fe) }}
          </nz-tag>
        }
        @if (selectedFeatures().length === 0) {
          <p class="text-gray-500">Chưa chọn feature nào</p>
        }
      </div>
      <p class="text-xs text-gray-500 mt-1">
        Các features được chọn sẽ tự động thuộc plan này.
      </p>
    </nz-form-control>
  </nz-form-item>

  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24">Prices</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24">
      <button (click)="openPriceModal()" nz-button nzType="default" type="button">
        <span nz-icon nzType="team"></span> Chọn Price
      </button>

      <div class="mt-3 flex flex-wrap gap-2">
        @for (pr of selectedPrices(); track pr.id) {
          <nz-tag
            nzColor="geekblue"
            nzClosable
            (nzOnClose)="removeSelectedPrice(pr.id)"
          >
            {{ getPriceDescription(pr) }}
          </nz-tag>
        }
        @if (selectedFeatures().length === 0) {
          <p class="text-gray-500">Chưa chọn price nào</p>
        }
      </div>
      <p class="text-xs text-gray-500 mt-1">
        Các prices được chọn sẽ tự động thuộc plan này.
      </p>
    </nz-form-control>
  </nz-form-item>

  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Tenant</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24">
      <button (click)="openTenantModal()" nz-button nzType="default" type="button">
        <span nz-icon nzType="container"></span> Choose Tenant
      </button>

      @if (selectedTenant(); as tenant) {
        <nz-card class="mt-3" nzHoverable>
          <nz-card-meta
            nzTitle="{{ tenant.name }}"
            nzDescription="{{ tenant.id }} • {{ tenant.email }}"
          ></nz-card-meta>
          <button type="button" nz-button nzType="link" nzDanger (click)="clearTenant()">Delete</button>
        </nz-card>
      } @else {
        <p class="text-gray-500 mt-2">Tenant is not chosen</p>
      }
    </nz-form-control>
  </nz-form-item>

  <nz-form-item class="mt-8" nz-row>
    <nz-form-control [nzOffset]="6" [nzSpan]="14">
      <button
        [disabled]="formGroup()?.invalid || isLoading()"
        [nzLoading]="isLoading()"
        nz-button
        nzType="primary"
      >
        {{ submitLabel() }}
      </button>
    </nz-form-control>
  </nz-form-item>
</form>
<nz-modal
  (nzOnCancel)="isTenantModalOpen.set(false)"
  (nzOnOk)="isTenantModalOpen.set(false)"
  [nzVisible]="isTenantModalOpen()"
  nzCancelText="Đóng"
  nzOkText="Xác nhận"
  nzTitle="Chọn Tenant"
>
  <ng-template nzModalContent>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
      @if (availableTenants().length === 0) {
        <p class="text-center text-gray-500 py-10">Không có tenant nào để chọn</p>
      } @else {
        @for (tenant of availableTenants(); track tenant.id) {
          <nz-card nzHoverable (click)="selectTenant(tenant)">
            <nz-card-meta
              nzTitle="{{ tenant.name }}"
              nzDescription="{{ tenant.id }} • {{ tenant.email}}"
            ></nz-card-meta>
          </nz-card>
        }
      }
    </div>
  </ng-template>
</nz-modal>
<nz-modal
  (nzOnCancel)="isPlanGroupModalOpen.set(false)"
  (nzOnOk)="isPlanGroupModalOpen.set(false)"
  [nzVisible]="isPlanGroupModalOpen()"
  nzCancelText="Đóng"
  nzOkText="Xác nhận"
  nzTitle="Chọn Plan Group"
>
  <ng-template nzModalContent>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
      @if (availablePlanGroups().length === 0) {
        <p class="text-center text-gray-500 py-10">Không có plan group nào để chọn</p>
      } @else {
        @for (pg of availablePlanGroups(); track pg.id) {
          <nz-card nzHoverable (click)="selectPlanGroup(pg)">
            <nz-card-meta
              nzTitle="{{ pg.name }}"
              nzDescription="{{ pg.id }} • {{ pg.description}}"
            ></nz-card-meta>
          </nz-card>
        }
      }
    </div>
  </ng-template>
</nz-modal>

<nz-modal
  (nzOnCancel)="isFeatureModalOpen.set(false)"
  (nzOnOk)="isFeatureModalOpen.set(false)"
  [nzVisible]="isFeatureModalOpen()"
  nzCancelText="Đóng"
  nzOkText="Xác nhận"
  nzTitle="Chọn feature để Gán"
>
  <ng-template nzModalContent>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto p-4">
      @if (availableFeatures().length === 0) {
        <div class="col-span-full text-center py-10 text-gray-500">
          <nz-icon nzType="usergroup-delete" class="text-5xl mb-4"></nz-icon>
          <p class="text-lg">Không có feature nào để chọn</p>
          <p class="text-sm mt-2">Có thể chưa có feture trong hệ thống hoặc đang tải dữ liệu.</p>
        </div>
      } @else {
        @for (fe of availableFeatures(); track fe.id) {
          <nz-card nzHoverable class="relative cursor-pointer" (click)="toggleFeature(fe)">
            <label
              nz-checkbox
              class="absolute top-3 right-3 z-10"
              [nzChecked]="isFeatureSelected(fe.id)"
              (nzCheckedChange)="toggleFeature(fe)"
            ></label>

            <nz-card-meta
              nzTitle="{{ fe.id || 'Unknown' }}"
              [nzDescription]="getFeatureDescription(fe)"
            ></nz-card-meta>
          </nz-card>
        }
      }
    </div>
  </ng-template>
</nz-modal>
<nz-modal
  (nzOnCancel)="isPriceModalOpen.set(false)"
  (nzOnOk)="isPriceModalOpen.set(false)"
  [nzVisible]="isPriceModalOpen()"
  nzCancelText="Đóng"
  nzOkText="Xác nhận"
  nzTitle="Chọn price để Gán"
>
  <ng-template nzModalContent>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto p-4">
      @if (availablePrices().length === 0) {
        <div class="col-span-full text-center py-10 text-gray-500">
          <nz-icon nzType="usergroup-delete" class="text-5xl mb-4"></nz-icon>
          <p class="text-lg">Không có price nào để chọn</p>
          <p class="text-sm mt-2">Có thể chưa có price trong hệ thống hoặc đang tải dữ liệu.</p>
        </div>
      } @else {
        @for (pr of availablePrices(); track pr.id) {
          <nz-card nzHoverable class="relative cursor-pointer" (click)="togglePrice(pr)">
            <label
              nz-checkbox
              class="absolute top-3 right-3 z-10"
              [nzChecked]="isPriceSelected(pr.id)"
              (nzCheckedChange)="togglePrice(pr)"
            ></label>

            <nz-card-meta
              nzTitle="{{ pr.id || 'Unknown' }}"
              [nzDescription]="getPriceDescription(pr)"
            ></nz-card-meta>
          </nz-card>
        }
      }
    </div>
  </ng-template>
</nz-modal>
