<form (ngSubmit)="onSubmit()" [formGroup]="formGroup()" nz-form>
  <!-- Tenant Name -->
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="name" nzRequired>Tên Tenant</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Tên tenant từ 3-50 ký tự">
      <input formControlName="name" id="name" nz-input placeholder="Ví dụ: Công ty ABC Tenant"/>
    </nz-form-control>
  </nz-form-item>

  <!-- Email -->
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="email" nzRequired>Email liên hệ</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="Email không hợp lệ">
      <input formControlName="email" id="email" nz-input placeholder="email@tenant.com"/>
    </nz-form-control>
  </nz-form-item>

  <!-- Creator: Button mở modal + preview -->
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired>Người tạo (Creator)</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24">
      <button (click)="openCreatorModal()" nz-button nzType="default" type="button">
        <span nz-icon nzType="user-add"></span> Chọn Creator
      </button>

      @if (selectedCreator(); as creator) {
        <nz-card class="mt-3" nzHoverable>
          <nz-card-meta
            nzTitle="{{ creator.username }}"
            nzDescription="{{ creator.email }} • {{ creator.role || 'User' }}"
          ></nz-card-meta>
          <button nz-button nzType="link" nzDanger (click)="clearCreator()">Xóa lựa chọn</button>
        </nz-card>
      } @else {
        <p class="text-gray-500 mt-2">Chưa chọn creator</p>
      }
    </nz-form-control>
  </nz-form-item>

  <!-- Assign Users: Button mở modal + preview tags -->
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24">Gán Users</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24">
      <button (click)="openUsersModal()" nz-button nzType="default" type="button">
        <span nz-icon nzType="team"></span> Chọn Users
      </button>

      <div class="mt-3 flex flex-wrap gap-2">
        @for (user of selectedUsers(); track user.id) {
          <nz-tag
            nzColor="geekblue"
            nzClosable
            (nzOnClose)="removeSelectedUser(user.id)"
          >
            {{ user.username }} ({{ user.email }}) • {{ user.role || 'User' }}
          </nz-tag>
        }
        @if (selectedUsers().length === 0) {
          <p class="text-gray-500">Chưa chọn user nào</p>
        }
      </div>
      <p class="text-xs text-gray-500 mt-1">
        Các user được chọn sẽ tự động thuộc tenant này.
      </p>
    </nz-form-control>
  </nz-form-item>

  <!-- Current & Pending Amount -->
  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24">Số dư hiện tại</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24">
      <input formControlName="currentAmount" min="0" nz-input placeholder="0" type="number"/>
    </nz-form-control>
  </nz-form-item>

  <nz-form-item>
    <nz-form-label [nzSm]="6" [nzXs]="24">Số dư chờ xử lý</nz-form-label>
    <nz-form-control [nzSm]="14" [nzXs]="24">
      <input formControlName="pendingAmount" min="0" nz-input placeholder="0" type="number"/>
    </nz-form-control>
  </nz-form-item>

  <!-- API Key (edit mode) -->
  @if (isEditMode()) {
    <nz-form-item>
      <nz-form-label [nzSm]="6" [nzXs]="24">API Key (Chỉ đọc)</nz-form-label>
      <nz-form-control [nzSm]="14" [nzXs]="24">
        @let currentApiKey = apiKeyValue();

        <div class="flex items-center gap-3">
          <nz-tag nzColor="processing" class="font-mono">
            {{ maskedApiKey() }}
          </nz-tag>

          <button
            nz-button
            nzType="text"
            nzShape="circle"
            (click)="copyApiKey(currentApiKey)"
            nz-tooltip
            nzTooltipTitle="Copy full API Key"
          >
            <span nz-icon nzType="copy"></span>
          </button>

          <button
            nz-button
            nzType="text"
            nzShape="circle"
            nz-popconfirm
            nzPopconfirmTitle="Tạo lại API Key mới? Key cũ sẽ vô hiệu hóa."
            (nzOnConfirm)="refreshApiKey()"
            nz-tooltip
            nzTooltipTitle="Tạo lại API Key"
          >
            <span nz-icon nzType="sync" class="text-orange-600"></span>
          </button>
        </div>
      </nz-form-control>
    </nz-form-item>
  }

  <!-- Submit -->
  <nz-form-item class="mt-8" nz-row>
    <nz-form-control [nzOffset]="6" [nzSpan]="14">
      <button
        [disabled]="formGroup()?.invalid || isLoading()"
        [nzLoading]="isLoading()"
        nz-button
        nzType="primary"
      >
        {{ submitLabel() }}
      </button>
    </nz-form-control>
  </nz-form-item>
</form>

<!-- Modal Creator -->
<nz-modal
  (nzOnCancel)="isCreatorModalOpen.set(false)"
  (nzOnOk)="isCreatorModalOpen.set(false)"
  [nzVisible]="isCreatorModalOpen()"
  nzCancelText="Đóng"
  nzOkText="Xác nhận"
  nzTitle="Chọn Creator"
>
  <ng-template nzModalContent>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
      @if (availableUsers().length === 0) {
        <p class="text-center text-gray-500 py-10">Không có user nào để chọn</p>
      } @else {
        @for (user of availableUsers(); track user.id) {
          <nz-card nzHoverable (click)="selectCreator(user)">
            <nz-card-meta
              nzTitle="{{ user.username }}"
              nzDescription="{{ user.email }} • {{ user.role || 'User' }}"
            ></nz-card-meta>
          </nz-card>
        }
      }
    </div>
  </ng-template>
</nz-modal>

<!--Modal Assign Users-->
<!-- Modal Assign Users -->
<nz-modal
  (nzOnCancel)="isUsersModalOpen.set(false)"
  (nzOnOk)="isUsersModalOpen.set(false)"
  [nzVisible]="isUsersModalOpen()"
  nzCancelText="Đóng"
  nzOkText="Xác nhận"
  nzTitle="Chọn Users để Gán"
>
  <ng-template nzModalContent>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto p-4">
      @if (availableUsers().length === 0) {
        <div class="col-span-full text-center py-10 text-gray-500">
          <nz-icon nzType="usergroup-delete" class="text-5xl mb-4"></nz-icon>
          <p class="text-lg">Không có user nào để chọn</p>
          <p class="text-sm mt-2">Có thể chưa có user trong hệ thống hoặc đang tải dữ liệu.</p>
        </div>
      } @else {
        @for (user of availableUsers(); track user.id) {
          <nz-card nzHoverable class="relative cursor-pointer" (click)="toggleUser(user)">
            <label
              nz-checkbox
              class="absolute top-3 right-3 z-10"
              [nzChecked]="isUserSelected(user.id)"
              (nzCheckedChange)="toggleUser(user)"
            ></label>

            <nz-card-meta
              nzTitle="{{ user.username || 'Unknown' }}"
              nzDescription="{{ user.email }} • {{ user.role || 'User' }}"
            ></nz-card-meta>
          </nz-card>
        }
      }
    </div>
  </ng-template>
</nz-modal>
